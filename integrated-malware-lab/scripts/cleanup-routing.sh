#!/bin/bash

###############################################################################
# Host Network Routing Cleanup Script
# Loại bỏ tất cả routing rules được tạo bởi setup-routing.sh
#
# Yêu cầu: sudo/root privileges
###############################################################################

set -e

# Màu sắc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Hàm log
log_info() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${GREEN}[ROUTING CLEANUP]${NC} $1"
}

log_warn() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${YELLOW}[ROUTING CLEANUP WARN]${NC} $1"
}

log_error() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${RED}[ROUTING CLEANUP ERROR]${NC} $1"
    exit 1
}

###############################################################################
# KIỂM TRA QUYỀN SUDO
###############################################################################

if [ "$EUID" -ne 0 ]; then 
    log_error "Script này yêu cầu chạy với quyền sudo/root!"
fi

###############################################################################
# LOẠI BỎ IPTABLES RULES
###############################################################################

log_info "Loại bỏ iptables NAT rules..."

# Danh sách các rules cần loại bỏ
RULES_TO_REMOVE=(
    "OUTPUT -p udp -m udp --dport 53 -j DNAT --to-destination 172.21.0.2:53"
    "OUTPUT -p tcp -m tcp --dport 53 -j DNAT --to-destination 172.21.0.2:53"
    "OUTPUT -p tcp -m tcp --dport 80 -j DNAT --to-destination 172.21.0.3:80"
    "OUTPUT -p tcp -m tcp --dport 443 -j DNAT --to-destination 172.21.0.3:443"
    "OUTPUT -p tcp -m tcp --dport 25 -j DNAT --to-destination 172.21.0.2:25"
    "OUTPUT -p tcp -m tcp --dport 21 -j DNAT --to-destination 172.21.0.2:21"
)

# Xóa từng rule
for rule in "${RULES_TO_REMOVE[@]}"; do
    log_info "  Xóa rule: $rule"
    sudo iptables -t nat -D $rule 2>/dev/null || log_warn "    Rule không tìm thấy hoặc không thể xóa"
done

###############################################################################
# LOẠI BỎ FORWARD RULES
###############################################################################

log_info "Loại bỏ FORWARD rules..."

sudo iptables -D FORWARD -i docker0 -o docker0 -j ACCEPT 2>/dev/null || log_warn "  Forward docker0->docker0 rule không tìm thấy"
sudo iptables -D FORWARD -i lo -o docker0 -j ACCEPT 2>/dev/null || log_warn "  Forward lo->docker0 rule không tìm thấy"

###############################################################################
# LOẠI BỎ ROUTES
###############################################################################

log_info "Loại bỏ routes..."

DOCKER_SUBNET="172.21.0.0/24"
sudo ip route del "${DOCKER_SUBNET}" 2>/dev/null || log_warn "  Route ${DOCKER_SUBNET} không tìm thấy"

###############################################################################
# KIỂM TRA FIREWALL STATUS
###############################################################################

log_info "Kiểm tra iptables status..."

RULE_COUNT=$(sudo iptables -t nat -L -n | wc -l)
log_info "  Số rules NAT còn lại: ${RULE_COUNT}"

###############################################################################
# OPTIONALLY: DISABLE IP FORWARDING
###############################################################################

# Hỏi người dùng có muốn tắt IP forwarding không
read -p "Có muốn tắt IP forwarding? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    log_info "Tắt IP forwarding..."
    echo 0 | sudo tee /proc/sys/net/ipv4/ip_forward > /dev/null
    log_info "  IP forwarding: DISABLED"
fi

###############################################################################
# SAVE CLEANED IPTABLES RULES
###############################################################################

log_info "Lưu cleaned iptables rules..."

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
CLEANED_RULES="${SCRIPT_DIR}/iptables.rules.cleaned"

if command -v iptables-save &> /dev/null; then
    sudo iptables-save > "${CLEANED_RULES}" 2>/dev/null || log_warn "Cannot save cleaned rules"
    log_info "  Saved to: ${CLEANED_RULES}"
fi

###############################################################################
# FINAL STATUS
###############################################################################

log_info ""
log_info "=========================================="
log_info "ROUTING CLEANUP SUMMARY"
log_info "=========================================="
log_info ""
log_info "Tất cả routing rules đã được loại bỏ"
log_info ""
log_info "Để completely reset networking, chạy:"
echo "  docker network prune"
echo "  docker-compose down"
log_info ""
log_info "=========================================="
log_info "Cleanup hoàn tất!"
log_info "=========================================="
