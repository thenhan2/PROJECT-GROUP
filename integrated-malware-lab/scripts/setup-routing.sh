#!/bin/bash

###############################################################################
# Host Network Routing Setup Script
# Cấu hình định tuyến trên máy host để điều hướng malware traffic
# vào Malware Analysis Lab environment
#
# Yêu cầu: sudo/root privileges
# OS: Linux/macOS
###############################################################################

set -e

# Màu sắc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Hàm log
log_info() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${GREEN}[ROUTING SETUP]${NC} $1"
}

log_warn() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${YELLOW}[ROUTING SETUP WARN]${NC} $1"
}

log_error() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${RED}[ROUTING SETUP ERROR]${NC} $1"
    exit 1
}

###############################################################################
# KIỂM TRA QUYỀN SUDO
###############################################################################

if [ "$EUID" -ne 0 ]; then 
    log_error "Script này yêu cầu chạy với quyền sudo/root!"
fi

###############################################################################
# KIỂM TRA DOCKER NETWORK
###############################################################################

log_info "Kiểm tra Docker network..."

DOCKER_NETWORK="malware_lab"
DOCKER_GATEWAY="172.21.0.1"
DOCKER_SUBNET="172.21.0.0/24"

# Kiểm tra nếu docker network tồn tại
if docker network inspect "${DOCKER_NETWORK}" >/dev/null 2>&1; then
    log_info "Docker network '${DOCKER_NETWORK}' đã tồn tại"
    GATEWAY_IP=$(docker network inspect "${DOCKER_NETWORK}" -f '{{(index .IPAM.Config 0).Gateway}}')
    SUBNET=$(docker network inspect "${DOCKER_NETWORK}" -f '{{(index .IPAM.Config 0).Subnet}}')
    log_info "  Gateway: ${GATEWAY_IP}"
    log_info "  Subnet: ${SUBNET}"
else
    log_warn "Docker network '${DOCKER_NETWORK}' không tồn tại"
    log_info "Vui lòng chạy: docker-compose up -d trước tiên"
fi

###############################################################################
# KIỂM TRA DOCKER BRIDGE
###############################################################################

log_info "Kiểm tra Docker bridge interface..."

DOCKER_BRIDGE=$(ip link show | grep "^[0-9]*: br" | awk -F: '{print $2}' | xargs -I{} echo {} | head -n 1)

if [ -z "$DOCKER_BRIDGE" ]; then
    # Cố gắng tìm bridge từ docker network
    DOCKER_BRIDGE=$(docker network inspect "${DOCKER_NETWORK}" -f '{{.ID}}' 2>/dev/null | cut -c1-12 || echo "br-")
    DOCKER_BRIDGE="br-${DOCKER_BRIDGE}"
fi

log_info "Docker bridge: $DOCKER_BRIDGE"

# Kiểm tra nếu bridge tồn tại
if ! ip link show "$DOCKER_BRIDGE" >/dev/null 2>&1; then
    log_warn "Docker bridge '$DOCKER_BRIDGE' không tìm thấy"
    log_info "Danh sách các bridge hiện tại:"
    ip link show | grep "^[0-9]*: br"
fi

###############################################################################
# CẤU HÌNH CONTAINER IPS
###############################################################################

log_info "Cấu hình container IPs..."

INETSIM_IP="172.21.0.2"
FAKENET_IP="172.21.0.3"

# Kiểm tra nếu containers đang chạy
INETSIM_RUNNING=$(docker ps | grep "inetsim-server" || echo "")
FAKENET_RUNNING=$(docker ps | grep "fakenet-ng-server" || echo "")

if [ -n "$INETSIM_RUNNING" ]; then
    INETSIM_ACTUAL_IP=$(docker inspect inetsim-server -f '{{.NetworkSettings.Networks.malware_lab.IPAddress}}' 2>/dev/null || echo "$INETSIM_IP")
    log_info "INetSim IP: ${INETSIM_ACTUAL_IP}"
else
    log_warn "INetSim container không chạy"
fi

if [ -n "$FAKENET_RUNNING" ]; then
    FAKENET_ACTUAL_IP=$(docker inspect fakenet-ng-server -f '{{.NetworkSettings.Networks.malware_lab.IPAddress}}' 2>/dev/null || echo "$FAKENET_IP")
    log_info "FakeNet-NG IP: ${FAKENET_ACTUAL_IP}"
else
    log_warn "FakeNet-NG container không chạy"
fi

###############################################################################
# CẤU HÌNH IPTABLES RULES
###############################################################################

log_info "Cấu hình iptables rules..."

# DNS redirection (UDP port 53)
log_info "  - DNS redirection (port 53 UDP -> ${INETSIM_IP}:53)"
sudo iptables -t nat -A OUTPUT -p udp -m udp --dport 53 -j DNAT --to-destination "${INETSIM_IP}:53" 2>/dev/null || \
    log_warn "    Cannot set DNS rule via iptables (might need additional configuration)"

# DNS redirection (TCP port 53)
log_info "  - DNS redirection (port 53 TCP -> ${INETSIM_IP}:53)"
sudo iptables -t nat -A OUTPUT -p tcp -m tcp --dport 53 -j DNAT --to-destination "${INETSIM_IP}:53" 2>/dev/null || \
    log_warn "    Cannot set DNS rule via iptables"

# HTTP redirection (port 80)
log_info "  - HTTP redirection (port 80 TCP -> ${FAKENET_IP}:80)"
sudo iptables -t nat -A OUTPUT -p tcp -m tcp --dport 80 -j DNAT --to-destination "${FAKENET_IP}:80" 2>/dev/null || \
    log_warn "    Cannot set HTTP rule via iptables"

# HTTPS redirection (port 443)
log_info "  - HTTPS redirection (port 443 TCP -> ${FAKENET_IP}:443)"
sudo iptables -t nat -A OUTPUT -p tcp -m tcp --dport 443 -j DNAT --to-destination "${FAKENET_IP}:443" 2>/dev/null || \
    log_warn "    Cannot set HTTPS rule via iptables"

# SMTP redirection (port 25)
log_info "  - SMTP redirection (port 25 TCP -> ${INETSIM_IP}:25)"
sudo iptables -t nat -A OUTPUT -p tcp -m tcp --dport 25 -j DNAT --to-destination "${INETSIM_IP}:25" 2>/dev/null || \
    log_warn "    Cannot set SMTP rule via iptables"

# FTP redirection (port 21)
log_info "  - FTP redirection (port 21 TCP -> ${INETSIM_IP}:21)"
sudo iptables -t nat -A OUTPUT -p tcp -m tcp --dport 21 -j DNAT --to-destination "${INETSIM_IP}:21" 2>/dev/null || \
    log_warn "    Cannot set FTP rule via iptables"

###############################################################################
# CẤU HÌNH IP FORWARDING
###############################################################################

log_info "Bật IP forwarding..."

if [ "$(cat /proc/sys/net/ipv4/ip_forward)" != "1" ]; then
    echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward > /dev/null
    log_info "  IP forwarding: ENABLED"
else
    log_info "  IP forwarding: Already enabled"
fi

###############################################################################
# CẤU HÌNH LOCAL NETWORK ROUTES
###############################################################################

log_info "Cấu hình routes cho subnet Docker..."

# Route tới Docker subnet qua Docker bridge gateway
if [ -n "$DOCKER_BRIDGE" ]; then
    # Lấy IP của Docker bridge
    DOCKER_GATEWAY_IP=$(ip addr show "$DOCKER_BRIDGE" 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d/ -f1 || echo "$DOCKER_GATEWAY")
    
    log_info "  Thêm route: ${DOCKER_SUBNET} via ${DOCKER_GATEWAY_IP} (qua ${DOCKER_BRIDGE})"
    ip route add "${DOCKER_SUBNET}" via "${DOCKER_GATEWAY_IP}" dev "$DOCKER_BRIDGE" 2>/dev/null || \
        log_warn "    Route đã tồn tại hoặc không thể thêm"
fi

###############################################################################
# CẤU HÌNH NETFILTER RULES (CONNTRACK)
###############################################################################

log_info "Cấu hình netfilter rules..."

# Enable connection tracking
sudo modprobe nf_conntrack 2>/dev/null || log_warn "Cannot load nf_conntrack module"

# Set conntrack expiration times
if [ -f /proc/sys/net/netfilter/nf_conntrack_tcp_timeout_established ]; then
    echo 600 | sudo tee /proc/sys/net/netfilter/nf_conntrack_tcp_timeout_established > /dev/null
    log_info "  TCP established timeout: 600s"
fi

###############################################################################
# CẤU HÌNH FIREWALL RULES
###############################################################################

log_info "Cấu hình firewall rules..."

# Allow traffic từ host tới Docker network
sudo iptables -I FORWARD -i docker0 -o docker0 -j ACCEPT 2>/dev/null || true
sudo iptables -I FORWARD -i lo -o docker0 -j ACCEPT 2>/dev/null || true

log_info "  Docker network traffic: ALLOWED"

###############################################################################
# LƯU IPTABLES RULES
###############################################################################

log_info "Lưu iptables rules (Linux)..."

if command -v iptables-save &> /dev/null; then
    RULES_FILE="${SCRIPT_DIR}/iptables.rules"
    sudo iptables-save > "${RULES_FILE}" 2>/dev/null || log_warn "Cannot save iptables rules"
    log_info "  Rules saved to: ${RULES_FILE}"
    
    # Tạo script để restore rules on boot
    if [ -f /etc/init.d/iptables ] || [ -d /etc/systemd/system ]; then
        log_info "  Để restore rules on system restart, chạy:"
        echo "    sudo bash -c 'iptables-restore < ${RULES_FILE}'"
    fi
fi

###############################################################################
# TRÌNH BÀY CẤU HÌNH ROUTING
###############################################################################

log_info ""
log_info "=========================================="
log_info "ROUTING CONFIGURATION SUMMARY"
log_info "=========================================="
log_info ""
log_info "Container IPs:"
log_info "  - INetSim:     ${INETSIM_IP}"
log_info "  - FakeNet-NG:  ${FAKENET_IP}"
log_info "  - Gateway:     ${DOCKER_GATEWAY}"
log_info "  - Subnet:      ${DOCKER_SUBNET}"
log_info ""
log_info "Traffic Redirection Rules:"
log_info "  - DNS (53/UDP):   -> INetSim (${INETSIM_IP}:53)"
log_info "  - DNS (53/TCP):   -> INetSim (${INETSIM_IP}:53)"
log_info "  - HTTP (80/TCP):  -> FakeNet-NG (${FAKENET_IP}:80)"
log_info "  - HTTPS (443/TCP) -> FakeNet-NG (${FAKENET_IP}:443)"
log_info "  - SMTP (25/TCP):  -> INetSim (${INETSIM_IP}:25)"
log_info "  - FTP (21/TCP):   -> INetSim (${INETSIM_IP}:21)"
log_info ""
log_info "IP Forwarding: ENABLED"
log_info "=========================================="
log_info ""

###############################################################################
# COMMAND ĐỂ KIỂM TRA ROUTING
###############################################################################

log_info "Kiểm tra routing configuration:"
log_info ""
log_info "View iptables NAT rules:"
echo "  sudo iptables -t nat -L -n -v"
log_info ""
log_info "View routing table:"
echo "  ip route show"
log_info ""
log_info "Test DNS resolution (from host):"
echo "  nslookup example.com"
log_info ""
log_info "Test HTTP connectivity (from host):"
echo "  curl http://example.com"
log_info ""
log_info "=========================================="
log_info "Routing setup hoàn tất!"
log_info "=========================================="
