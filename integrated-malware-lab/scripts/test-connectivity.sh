#!/bin/bash

###############################################################################
# Malware Analysis Lab - Connectivity Test Script
# Kiểm tra kết nối giữa host, containers, và external services
###############################################################################

set -e

# Màu sắc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# Hàm log
log_info() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${GREEN}[TEST]${NC} $1"
}

log_ok() {
    echo -e "${GREEN}✓ $1${NC}"
}

log_fail() {
    echo -e "${RED}✗ $1${NC}"
}

log_warn() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

test_status() {
    if [ $? -eq 0 ]; then
        log_ok "$1"
    else
        log_fail "$1"
    fi
}

###############################################################################
# 1. KIỂM TRA DOCKER STATUS
###############################################################################

log_info "=========================================="
log_info "DOCKER STATUS"
log_info "=========================================="

# Kiểm tra Docker daemon
if command -v docker &> /dev/null; then
    if docker ps >/dev/null 2>&1; then
        log_ok "Docker daemon is running"
    else
        log_fail "Docker daemon is not accessible"
    fi
else
    log_fail "Docker is not installed"
fi

# Kiểm tra Docker Compose
if command -v docker-compose &> /dev/null; then
    log_ok "Docker Compose is installed"
else
    log_warn "Docker Compose is not installed"
fi

echo ""

###############################################################################
# 2. KIỂM TRA CONTAINERS
###############################################################################

log_info "=========================================="
log_info "CONTAINER STATUS"
log_info "=========================================="

# Kiểm tra nếu containers đang chạy
DOCKER_NETWORK="malware_lab"

# INetSim container
log_info "Checking INetSim container..."
if docker ps | grep -q "inetsim-server"; then
    log_ok "INetSim container is running"
    
    INETSIM_IP=$(docker inspect inetsim-server -f '{{.NetworkSettings.Networks.malware_lab.IPAddress}}' 2>/dev/null || echo "unknown")
    log_info "  IP Address: ${INETSIM_IP}"
    
    # Kiểm tra DNS service
    if docker exec inetsim-server nc -u -z 127.0.0.1 53 2>/dev/null; then
        log_ok "  DNS service is responding"
    else
        log_warn "  DNS service may not be responding"
    fi
else
    log_fail "INetSim container is not running"
fi

echo ""

# FakeNet-NG container
log_info "Checking FakeNet-NG container..."
if docker ps | grep -q "fakenet-ng-server"; then
    log_ok "FakeNet-NG container is running"
    
    FAKENET_IP=$(docker inspect fakenet-ng-server -f '{{.NetworkSettings.Networks.malware_lab.IPAddress}}' 2>/dev/null || echo "unknown")
    log_info "  IP Address: ${FAKENET_IP}"
    
    # Kiểm tra HTTP service
    if docker exec fakenet-ng-server nc -z 127.0.0.1 80 2>/dev/null; then
        log_ok "  HTTP service is responding"
    else
        log_warn "  HTTP service may not be responding"
    fi
else
    log_fail "FakeNet-NG container is not running"
fi

echo ""

###############################################################################
# 3. KIỂM TRA NETWORK
###############################################################################

log_info "=========================================="
log_info "NETWORK CONNECTIVITY"
log_info "=========================================="

# Kiểm tra Docker network
log_info "Checking Docker network '${DOCKER_NETWORK}'..."
if docker network inspect "${DOCKER_NETWORK}" >/dev/null 2>&1; then
    log_ok "Docker network exists"
    
    GATEWAY=$(docker network inspect "${DOCKER_NETWORK}" -f '{{(index .IPAM.Config 0).Gateway}}' 2>/dev/null)
    SUBNET=$(docker network inspect "${DOCKER_NETWORK}" -f '{{(index .IPAM.Config 0).Subnet}}' 2>/dev/null)
    log_info "  Gateway: ${GATEWAY}"
    log_info "  Subnet: ${SUBNET}"
else
    log_fail "Docker network does not exist"
fi

echo ""

# Kiểm tra routing mặc định
log_info "Checking default routes..."
if ip route | grep -q "default via"; then
    DEFAULT_ROUTE=$(ip route | grep "default via" | awk '{print $3}')
    log_ok "Default route: $DEFAULT_ROUTE"
else
    log_warn "No default route found"
fi

echo ""

###############################################################################
# 4. KIỂM TRA SERVICES TRÊN CONTAINERS
###############################################################################

log_info "=========================================="
log_info "SERVICE PORTS"
log_info "=========================================="

# INetSim ports
log_info "INetSim ports:"
INETSIM_PORTS=(
    "53:UDP"
    "25:TCP"
    "21:TCP"
    "80:TCP"
    "443:TCP"
)

for port_spec in "${INETSIM_PORTS[@]}"; do
    port=${port_spec%:*}
    protocol=${port_spec#*:}
    
    if docker exec inetsim-server nc -w 1 -z 127.0.0.1 "$port" 2>/dev/null; then
        log_ok "  Port $port ($protocol): OPEN"
    else
        log_warn "  Port $port ($protocol): CLOSED/NOT RESPONDING"
    fi
done

echo ""

# FakeNet-NG ports
log_info "FakeNet-NG ports:"
FAKENET_PORTS=(
    "80:TCP"
    "443:TCP"
    "8080:TCP"
    "8443:TCP"
)

for port_spec in "${FAKENET_PORTS[@]}"; do
    port=${port_spec%:*}
    protocol=${port_spec#*:}
    
    if docker exec fakenet-ng-server nc -w 1 -z 127.0.0.1 "$port" 2>/dev/null; then
        log_ok "  Port $port ($protocol): OPEN"
    else
        log_warn "  Port $port ($protocol): CLOSED/NOT RESPONDING"
    fi
done

echo ""

###############################################################################
# 5. KIỂM TRA DNS RESOLUTION
###############################################################################

log_info "=========================================="
log_info "DNS RESOLUTION TEST"
log_info "=========================================="

if docker ps | grep -q "inetsim-server"; then
    log_info "Testing DNS resolution from INetSim container..."
    
    # Test nslookup
    if docker exec inetsim-server nslookup example.com 127.0.0.1 >/dev/null 2>&1; then
        log_ok "DNS query (nslookup) successful"
    else
        log_warn "DNS query (nslookup) failed"
    fi
    
    # Test using dig
    if command -v dig &> /dev/null; then
        if dig @172.21.0.2 example.com >/dev/null 2>&1; then
            log_ok "DNS query (dig) to 172.21.0.2 successful"
        else
            log_warn "DNS query (dig) to 172.21.0.2 failed"
        fi
    fi
else
    log_warn "INetSim container not running, skipping DNS tests"
fi

echo ""

###############################################################################
# 6. KIỂM TRA HTTP CONNECTIVITY
###############################################################################

log_info "=========================================="
log_info "HTTP CONNECTIVITY TEST"
log_info "=========================================="

if docker ps | grep -q "fakenet-ng-server"; then
    log_info "Testing HTTP connectivity from FakeNet-NG container..."
    
    # Test using curl từ host
    if command -v curl &> /dev/null; then
        log_info "Testing HTTP to localhost port 80 (FakeNet-NG)..."
        
        HTTP_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80 2>/dev/null || echo "000")
        
        if [ "$HTTP_RESPONSE" != "000" ] && [ "$HTTP_RESPONSE" != "000" ]; then
            log_ok "HTTP response code: $HTTP_RESPONSE"
        else
            log_warn "HTTP request failed or no response"
        fi
        
        log_info "Testing HTTPS to localhost port 443 (FakeNet-NG)..."
        HTTPS_RESPONSE=$(curl -s -k -o /dev/null -w "%{http_code}" https://localhost:443 2>/dev/null || echo "000")
        
        if [ "$HTTPS_RESPONSE" != "000" ]; then
            log_ok "HTTPS response code: $HTTPS_RESPONSE"
        else
            log_warn "HTTPS request failed or no response"
        fi
    else
        log_warn "curl not installed, cannot test HTTP"
    fi
else
    log_warn "FakeNet-NG container not running, skipping HTTP tests"
fi

echo ""

###############################################################################
# 7. KIỂM TRA LOG FILES
###############################################################################

log_info "=========================================="
log_info "LOG FILES"
log_info "=========================================="

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
LOG_DIR="${SCRIPT_DIR}/../shared/logs"

if [ -d "$LOG_DIR" ]; then
    log_ok "Log directory exists: $LOG_DIR"
    
    echo ""
    echo "Log files:"
    find "$LOG_DIR" -type f -name "*.log" 2>/dev/null | while read logfile; do
        size=$(stat -f%z "$logfile" 2>/dev/null || stat -c%s "$logfile" 2>/dev/null || echo "unknown")
        echo "  - $(basename "$logfile") ($(du -h "$logfile" | awk '{print $1}'))"
    done
else
    log_warn "Log directory not found: $LOG_DIR"
fi

echo ""

###############################################################################
# 8. KIỂM TRA RESOURCE USAGE
###############################################################################

log_info "=========================================="
log_info "RESOURCE USAGE"
log_info "=========================================="

if docker stats --no-stream >/dev/null 2>&1; then
    log_info "Container resource usage:"
    docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
else
    log_warn "Cannot retrieve container stats"
fi

echo ""

###############################################################################
# FINAL SUMMARY
###############################################################################

log_info "=========================================="
log_info "TEST COMPLETE"
log_info "=========================================="

log_info ""
log_info "Next steps:"
log_info "1. Verify all services are running correctly"
log_info "2. Check logs in: $LOG_DIR"
log_info "3. Run malware samples in the lab environment"
log_info ""
