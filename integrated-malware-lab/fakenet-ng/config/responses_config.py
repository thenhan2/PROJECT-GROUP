#!/usr/bin/env python3
"""
FakeNet-NG Response Configuration
Defines custom responses for different malware requests

Created: Feb 2026 - Malware Analysis Lab Integration
"""

# Define response handlers for different types of requests
RESPONSE_HANDLERS = {
    # JSON responses (common for C2 communication)
    'json': {
        'pattern': r'.*\.json.*',
        'content': '{"status": "success", "timestamp": 1234567890}',
        'content_type': 'application/json'
    },
    
    # XML responses
    'xml': {
        'pattern': r'.*\.xml.*',
        'content': '<?xml version="1.0"?><root><status>ok</status></root>',
        'content_type': 'application/xml'
    },
    
    # API responses
    'api': {
        'pattern': r'.*/api/.*',
        'content': '{"result": "success", "data": []}',
        'content_type': 'application/json'
    },
    
    # Executable files
    'exe': {
        'pattern': r'.*\.(exe|dll|sys).*',
        'content': b'MZ\x90\x00\x03\x00\x00\x00',  # MZ header (PE format)
        'content_type': 'application/octet-stream'
    },
    
    # ZIP archives
    'zip': {
        'pattern': r'.*\.zip.*',
        'content': b'PK\x03\x04\x14\x00\x00\x00',  # ZIP header
        'content_type': 'application/zip'
    },
    
    # HTML responses
    'html': {
        'pattern': r'.*\.(html|htm).*|/$',
        'content': '''<html>
<head><title>Welcome</title></head>
<body>
<h1>Welcome to our Web Server</h1>
<p>This is a simulated web server for malware analysis.</p>
</body>
</html>''',
        'content_type': 'text/html'
    },
    
    # Text files
    'text': {
        'pattern': r'.*\.txt.*',
        'content': 'This is a text file.\nGenerated by FakeNet-NG\n',
        'content_type': 'text/plain'
    },
    
    # PHP scripts (serve as HTML)
    'php': {
        'pattern': r'.*\.php.*',
        'content': '<html><body>PHP execution disabled.</body></html>',
        'content_type': 'text/html'
    },
    
    # JavaScript files
    'javascript': {
        'pattern': r'.*\.js.*',
        'content': 'console.log("FakeNet-NG");',
        'content_type': 'application/javascript'
    },
    
    # CSS files
    'css': {
        'pattern': r'.*\.css.*',
        'content': 'body { color: black; }',
        'content_type': 'text/css'
    },
    
    # Images (minimal valid PNG)
    'png': {
        'pattern': r'.*\.png.*',
        'content': b'\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x06\x00\x00\x00\x1f\x15\xc4\x89',
        'content_type': 'image/png'
    },
    
    # JPEG images
    'jpeg': {
        'pattern': r'.*\.jpg.*|.*\.jpeg.*',
        'content': b'\xff\xd8\xff\xe0\x00\x10JFIF',
        'content_type': 'image/jpeg'
    },
    
    # GIF images
    'gif': {
        'pattern': r'.*\.gif.*',
        'content': b'GIF89a\x01\x00\x01\x00\x80\x00\x00\xff\xff\xff\x00\x00\x00!\xf9\x04\x01\x00\x00\x00\x00,',
        'content_type': 'image/gif'
    }
}

# Default response khi không match pattern nào
DEFAULT_RESPONSE = {
    'status': 200,
    'content': '<html><body><h1>404 Not Found</h1></body></html>',
    'content_type': 'text/html'
}

# HTTP Status codes
HTTP_STATUS_CODES = {
    200: 'OK',
    301: 'Moved Permanently',
    302: 'Found',
    304: 'Not Modified',
    400: 'Bad Request',
    403: 'Forbidden',
    404: 'Not Found',
    500: 'Internal Server Error',
    503: 'Service Unavailable'
}

# Custom headers để add vào responses
CUSTOM_HEADERS = {
    'Server': 'Microsoft-IIS/10.0',
    'X-Powered-By': 'ASP.NET',
    'Cache-Control': 'no-cache, no-store, must-revalidate',
    'Pragma': 'no-cache',
    'Expires': '0'
}

# Redirect patterns (URL -> Target)
REDIRECT_PATTERNS = {
    r'.*\.update.*': 'http://172.21.0.3/download/update.exe',
    r'.*\.check.*': 'http://172.21.0.3/',
}

# Block patterns (traffic will be dropped)
BLOCK_PATTERNS = [
    r'.*\.onion.*',  # Tor hidden services
    r'.*bitcon.*',   # Cryptocurrency
]

# Rate limiting per IP
RATE_LIMIT = {
    'enabled': True,
    'requests_per_minute': 1000,
    'burst_size': 100
}

# Logging configuration
LOGGING_CONFIG = {
    'log_requests': True,
    'log_responses': True,
    'log_headers': True,
    'log_body': False,  # Don't log large response bodies
    'max_body_log_size': 1024  # Max bytes to log from body
}

# Integration settings
INTEGRATION = {
    'inetsim_enabled': True,
    'inetsim_ip': '172.21.0.2',
    'inetsim_port': 80,
    'forward_unknown': True
}

def get_response_for_request(path, method='GET', headers=None):
    """
    Get appropriate response based on request path and method
    
    Args:
        path: URL path from request
        method: HTTP method (GET, POST, etc.)
        headers: Request headers dict
        
    Returns:
        dict with 'status', 'content', 'headers'
    """
    import re
    
    for handler_name, handler_config in RESPONSE_HANDLERS.items():
        if re.match(handler_config['pattern'], path, re.IGNORECASE):
            return {
                'status': 200,
                'content': handler_config['content'],
                'content_type': handler_config['content_type'],
                'headers': CUSTOM_HEADERS
            }
    
    # Default response
    return {
        'status': 404,
        'content': DEFAULT_RESPONSE['content'],
        'content_type': 'text/html',
        'headers': CUSTOM_HEADERS
    }


if __name__ == '__main__':
    # Test response generation
    test_paths = [
        '/api/check',
        '/update.exe',
        '/data.json',
        '/index.html',
        '/image.png'
    ]
    
    print("Testing FakeNet-NG Response Handler\n")
    for path in test_paths:
        response = get_response_for_request(path)
        print(f"Path: {path}")
        print(f"  Status: {response['status']}")
        print(f"  Content-Type: {response['content_type']}")
        print()
