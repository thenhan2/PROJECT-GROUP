#!/bin/bash

###############################################################################
# INetSim Entrypoint Script
# Chức năng: Cấu hình và khởi chạy INetSim service
# - DNS Server (Port 53)
# - SMTP Server (Port 25)
# - FTP Server (Port 21)
# - HTTP/HTTPS Fallback
###############################################################################

set -e

# Màu sắc cho output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

LOG_DIR="/var/log/inetsim"
INETSIM_CONF="/etc/inetsim/inetsim.conf"

# Hàm log
log_info() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${GREEN}[INetSim]${NC} $1"
}

log_warn() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${YELLOW}[INetSim WARN]${NC} $1"
}

log_error() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${RED}[INetSim ERROR]${NC} $1"
}

###############################################################################
# 1. Tạo log directory
###############################################################################
log_info "Tạo log directory..."
if [ ! -d "${LOG_DIR}" ]; then
    mkdir -p "${LOG_DIR}"
    chmod 755 "${LOG_DIR}"
fi

###############################################################################
# 2. Cấu hình INetSim
###############################################################################
log_info "Cấu hình INetSim..."

# Tạo file cấu hình mặc định nếu không có
if [ ! -f "${INETSIM_CONF}" ]; then
    log_warn "File cấu hình INetSim không tìm thấy tại ${INETSIM_CONF}"
    log_info "Sử dụng cấu hình mặc định từ /etc/inetsim/inetsim.conf.sample"
    
    if [ -f "/etc/inetsim/inetsim.conf.sample" ]; then
        cp /etc/inetsim/inetsim.conf.sample "${INETSIM_CONF}"
    else
        log_error "Không thể tìm thấy file cấu hình mẫu. Thoát."
        exit 1
    fi
fi

# Sửa đổi cấu hình INetSim:
# - Bind tất cả interfaces (0.0.0.0)
# - Bật DNS service
# - Bật SMTP service
# - Bật FTP service
log_info "Sửa đổi file cấu hình INetSim..."

# Đảm bảo DNS service được bật
sed -i 's/^#service_binds.*53.*/service_binds 0.0.0.0:53/' "${INETSIM_CONF}" || true
sed -i 's/^#dns_default_ip.*/dns_default_ip 172.21.0.2/' "${INETSIM_CONF}" || true

# Bật SMTP service
sed -i 's/^#service_binds.*25.*/service_binds 0.0.0.0:25/' "${INETSIM_CONF}" || true

# Bật FTP service
sed -i 's/^#service_binds.*21.*/service_binds 0.0.0.0:21/' "${INETSIM_CONF}" || true

# Bật HTTP service trên port 80
sed -i 's/^#service_binds.*80.*/service_binds 0.0.0.0:80/' "${INETSIM_CONF}" || true

# Bật HTTPS service trên port 443
sed -i 's/^#service_binds.*443.*/service_binds 0.0.0.0:443/' "${INETSIM_CONF}" || true

# Set logging
sed -i 's/^#log_file.*/log_file \/var\/log\/inetsim\/inetsim.log/' "${INETSIM_CONF}" || true
sed -i 's/^#log_level.*/log_level debug/' "${INETSIM_CONF}" || true

###############################################################################
# 3. Kiểm tra cấu hình INetSim
###############################################################################
log_info "Kiểm tra cấu hình..."
if ! inetsim --conf "${INETSIM_CONF}" --syntax-check 2>/dev/null; then
    log_warn "Cảnh báo: Cấu hình có thể không hợp lệ, tiếp tục..."
fi

###############################################################################
# 4. Cấu hình Network
###############################################################################
log_info "Cấu hình network interfaces..."

# Kiểm tra eth0 hoặc tương tự
IFACE=$(ip route | grep default | awk '{print $5}' | head -n 1)
if [ -z "$IFACE" ]; then
    IFACE="eth0"
fi

log_info "Sử dụng network interface: ${IFACE}"

# Kiểm tra và cấu hình IP forwarding
if [ "$(cat /proc/sys/net/ipv4/ip_forward)" != "1" ]; then
    log_info "Bật IP forwarding..."
    echo 1 > /proc/sys/net/ipv4/ip_forward 2>/dev/null || log_warn "Không thể bật IP forwarding"
fi

###############################################################################
# 5. Khởi chạy INetSim
###############################################################################
log_info "=========================================="
log_info "Khởi chạy INetSim..."
log_info "=========================================="
log_info "Configuration: ${INETSIM_CONF}"
log_info "Log file: ${LOG_DIR}/inetsim.log"
log_info "Services:"
log_info "  - DNS Server: 0.0.0.0:53 (UDP/TCP)"
log_info "  - SMTP Server: 0.0.0.0:25 (TCP)"
log_info "  - FTP Server: 0.0.0.0:21 (TCP)"
log_info "  - HTTP Server: 0.0.0.0:80 (TCP)"
log_info "  - HTTPS Server: 0.0.0.0:443 (TCP)"
log_info "=========================================="

# Khởi chạy inetsim với cấu hình
exec inetsim --conf "${INETSIM_CONF}" --log-dir "${LOG_DIR}" 2>&1 | tee -a "${LOG_DIR}/inetsim.log"
