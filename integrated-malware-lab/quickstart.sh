#!/bin/bash

###############################################################################
# Quick Start Script - Integrated Malware Analysis Lab
# Một lệnh để bắt đầu lab
###############################################################################

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[*]${NC} $1"
}

log_ok() {
    echo -e "${GREEN}[✓]${NC} $1"
}

log_error() {
    echo -e "${RED}[✗]${NC} $1"
}

###############################################################################
# Check Prerequisites
###############################################################################

echo ""
echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Integrated Malware Analysis Lab - Quick Start            ║${NC}"
echo -e "${BLUE}║  DevSecOps Edition - February 2026                        ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""

log_info "Kiểm tra yêu cầu hệ thống..."

# Check Docker
if ! command -v docker &> /dev/null; then
    log_error "Docker không được cài đặt"
    echo "Cài đặt từ: https://docs.docker.com/get-docker/"
    exit 1
fi
log_ok "Docker $(docker --version | awk '{print $3}' | cut -d, -f1)"

# Check Docker Compose
if ! command -v docker-compose &> /dev/null; then
    log_error "Docker Compose không được cài đặt"
    echo "Cài đặt từ: https://docs.docker.com/compose/install/"
    exit 1
fi
log_ok "Docker Compose $(docker-compose --version | awk '{print $3}' | cut -d, -f1)"

# Check sudo (warning only, will be required during routing setup)
if [ "$EUID" -ne 0 ]; then
    log_info "⚠️  Sudo access sẽ được yêu cầu để cấu hình routing"
fi

# Check disk space
DISK_AVAILABLE=$(df -BG . | awk 'NR==2 {print $4}' | sed 's/G//')
if [ "$DISK_AVAILABLE" -lt 10 ]; then
    log_error "Không đủ dung lượng (yêu cầu 10GB, có ${DISK_AVAILABLE}GB)"
    exit 1
fi
log_ok "Dung lượng đủ (${DISK_AVAILABLE}GB available)"

echo ""
log_info "Cấu hình Docker..."

# Detect Windows-like shells (Git Bash / MSYS / MINGW / Cygwin)
UNAME_OUT="$(uname -s 2>/dev/null || echo unknown)"
case "$UNAME_OUT" in
    MINGW*|MSYS*|CYGWIN*)
        IS_WINDOWS_SHELL=1
        ;;
    *)
        IS_WINDOWS_SHELL=0
        ;;
esac

# Create necessary directories
log_info "Tạo thư mục logs..."
mkdir -p shared/logs/inetsim
mkdir -p shared/logs/fakenet-ng
mkdir -p shared/config
if [ "$IS_WINDOWS_SHELL" -eq 1 ]; then
    log_info "Bo qua chmod tren Windows shell"
else
    chmod -R 777 shared/ || log_info "Khong the chmod (co the do filesystem khong ho tro)"
fi

log_ok "Thư mục đã tạo"

# Build Docker images
log_info "Build Docker images (có thể mất 5-10 phút)..."
echo ""
docker-compose build --no-cache

echo ""
log_info "Khởi chạy services..."
docker-compose up -d

# Wait for services
log_info "Chờ services khởi động..."
sleep 5

# Check if services are running
if docker-compose ps | grep -q "Up"; then
    log_ok "Services đang chạy"
else
    log_error "Services không khởi động thành công"
    docker-compose logs
    exit 1
fi

echo ""
log_info "Cấu hình Host Network Routing..."
echo ""
if [ "$IS_WINDOWS_SHELL" -eq 1 ]; then
    log_info "Bo qua routing: khong ho tro tren Windows shell"
else
    if [ "$EUID" -eq 0 ]; then
        bash scripts/setup-routing.sh 2>&1 | grep -E "^[│├└]|INFO|ERROR" || true
    else
        sudo bash scripts/setup-routing.sh 2>&1 | grep -E "^[│├└]|INFO|ERROR" || true
    fi
fi

echo ""
echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  ✓ Lab Setup Complete!                                     ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Show status
echo -e "${BLUE}Service Status:${NC}"
docker-compose ps

echo ""
echo -e "${BLUE}Next Steps:${NC}"
echo "1. Test DNS:        nslookup example.com"
echo "2. View logs:       docker-compose logs -f"
echo "3. Run test:        bash scripts/test-connectivity.sh"
echo "4. Full guide:      cat docs/SETUP_GUIDE.md"
echo ""

echo -e "${BLUE}Useful Commands:${NC}"
echo "  Stop services:     docker-compose stop"
echo "  Restart:          docker-compose restart"
echo "  View logs:        docker-compose logs -f inetsim"
if [ "$IS_WINDOWS_SHELL" -eq 1 ]; then
    echo "  Clean up:         docker-compose down"
else
    echo "  Clean up:         sudo bash scripts/cleanup-routing.sh && docker-compose down"
fi
echo ""

echo -e "${YELLOW}⚠️  Important:${NC}"
echo "  - Lab network is isolated: 172.21.0.0/24"
echo "  - INetSim DNS:       172.21.0.2:53"
echo "  - FakeNet-NG HTTP:   172.21.0.3:80/443"
echo "  - Logs stored:       shared/logs/"
echo ""

log_ok "Integrated Malware Analysis Lab is READY!"
